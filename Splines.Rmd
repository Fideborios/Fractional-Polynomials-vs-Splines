---
title: "A new approach to investigate treatment effect modification over continuous co-variables in IPD-MA by using smoothing splines"
author: "Michail Belias"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{bbm}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{dsfont}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
output:
 word_document:
  reference_docx: Style and bibliography/templatePaper.docx
 indent: true  
 html_document:
  df_print: paged
 pdf_document:
  fig_caption: yes 
  fig_height: 8
  fig_width: 8
csl: Style and bibliography/journal-of-clinical-epidemiology.csl
fontsize: 14pt 
sansfont : GFS Neohellenic
bibliography: Style and bibliography/bibliography2.bib
---


```{r global_options , echo=FALSE, message=FALSE, warning= FALSE}
.libPaths( c( .libPaths(), "C:/Users/Michael Belias/Documents/R/win-library/3.4") )
rm(list=ls()) ### To clear namespace
## Fractional Polynomials
## Load data-set
if(!require("readr")) install.packages("readr")
## Load ggplot2 for plotting
if(!require("ggplot2")) install.packages("ggplot2")
## Load gridExtra for fine tuning
if(!require("gridExtra")) install.packages("gridExtra")
## Load knitr for fine tuning
if(!require("knitr")) install.packages("knitr")
## Load haven for fine tuning
if(!require("haven")) install.packages("haven")
## Load dplyr
if(!require("dplyr")) install.packages("dplyr")
## Load lme4 for lme4
if(!require("lme4")) install.packages("lme4")
## Load lme4 for lme4
if(!require("pander")) install.packages("pander")
## Load lme4 for lme4
if(!require("kableExtra")) install.packages("kableExtra")
## Load lme4 for lme4
if(!require("magick")) install.packages("magick")
## Load glmertree for glmm trees modelling
if(!require("glmertree")) install.packages("glmertree")
## Load GGally for better ggplot2 manipulation
if(!require("GGally")) install.packages("GGally")
## Load GGally for better ggplot2 manipulation
if(!require("readxl")) install.packages("readxl")
## Load GGally for better ggplot2 manipulation
if(!require("kableExtra")) install.packages("kableExtra")
## Load GGally for better ggplot2 manipulation
if(!require("ggsci")) install.packages("ggsci")
## Load broom for ggplot2  manipulation
if(!require("broom")) install.packages("broom")
## Load broom for ggplot2  manipulation
if(!require("metafor")) install.packages("metafor")
if(!require("effects")) install.packages("effects")
if(!require("mgcv")) install.packages("mgcv")
if(!require("itsadug")) install.packages("itsadug")
if(!require("mvmeta")) install.packages("mvmeta")
if(!require("mfp")) install.packages("mfp")
if(!require("knitr")) install.packages("knitr")
if(!require("aods3")) install.packages("aods3")
if(!require("car")) install.packages("car", dependencies = T)
if(!require("data.table")) install.packages("data.table")
if(!require("lmerTest")) install.packages("lmerTest")
if(!require("ggpubr")) install.packages("ggpubr")


opts_chunk$set(fig.width=9, fig.height=6, fig.path='Figs/',
        echo=F, warning=FALSE, message=FALSE, fig.pos = "H", comment = "")
options(knitr.table.format = "html")


Sys.setenv(PATH=paste(Sys.getenv("PATH"),"C:/Program Files/MiKTeX 2.9/miktex/bin/x64/",sep=";"))
Sys.setenv(R_GSCMD = "/usr/local/bin/gs")
```

```{r loading the datasets}

IPDMA <- read_sas("Data/IPDMA.sas7bdat")
names(IPDMA) <- tolower(names(IPDMA))
IPDMA$treat =  factor(IPDMA$treat  , labels = c("Placebo","Antibiotics") )
IPDMA$study = factor(IPDMA$study, labels = c("Damoiseaux","Burke","Appelman","Little","Saux","McCormick"))
IPDMA$bilat_0 =  factor(IPDMA$bilat_0  , labels = c("No","Yes") )




somatostatin <- read_sav("Data/somatostatin.sav")
source("Data/somatostatin_descriptives.R")
```

## Background

Individual participant data(IPD) meta-analysis(MA) of randomised clinical trials are considered the gold standard to investigate treatment efficiency. It is important to also investigate treatment-effect modification as the one-treatment fits all may not be true. Effect modification over a continuous co-variable may be challenging, when non-linear associations are present. Current statistical guidance involves: 1) categorising the effect modifier, 2) assuming linear or known polynomial shapes 3) or performing stepwise methods that rely on arbitrary statistical tests. 

## Objective 
We propose two new approaches to detect treatment-effect modification while modeling non-linear associations using smoothing splines. 

## Methods
For the one-stage IPD-MA approach we fitted a generalised additive mixed effects model with smoothing splines and compared the results with a generalised linear mixed effects model. For the two-stage approach, we fitted a smoothing spline per trial and pooled the results using point-wise meta-analytical methods and compared the results with the same approach assuming linearity.

## Results



## Conclusion



\newpage

##### 

# 1. Introduction

####### Randomised clinical trials (RCTs) are prospective interventional studies were patients are randomly allocated to different treatment arms. Randomisation reduces bias due to confounding and is considered [@Hariton_2018] the gold standard to investigate treatment effectiveness but not without a cost. RCTs are cost and time-consuming and may involve experimental interventions that may have adverse effects. Hence, due to both ethical and financial reasons RCTs are designed to include the minimum number of patients needed to detect an overall treatment effect with a pre-specified power. On the other hand, the assumption that all patients have the same response to treatment also known as one-treatment fits all may not be true. Therefore, in order to preserve adequate power while simultaneously investigating treatment effect differences we may need to combine multiple RCTs in a meta-analysis(MA). Meta-analyses may be conducted either using patient level or study level information and are known as individual participant data meta-analysis (IPD-MA) and aggregated data meta-analysis (AD-MA) respectively. Subgroup analysis and meta-regression are commonly applied AD-MA approaches, to detect effect modification [@Simmonds_2015]. Nevertheless, both approaches are considered prone to ecological bias [@GREENLAND_1989 ; @Palmowski_2019 ; @Reade_2008 ; @Berlin_2002] and low power [@Lambert_2002 ; @Riley_2010]. On the other hand, IPD-MA offers opportunities that in AD-MA are considered impossible such as: 1) the possibility to standardise subgroup definitions and outcomes across studies, 2) increased power to model non-linear functional forms, 3) increased validity and reliability of the resulting subgroups and 4) flexibility to search for subgroups based on combinations of patient and/or disease characteristics [@Debray_2015 ; @Maroeska_2012; @Tierney_2015]. Therefore, whenever IPD is available it is suggested to perform an IPD-MA rather than AD-MA [@Lambert_2002 ; @Fisher_2011 ; @Simmonds_2007 ; @Stewart_2002].

#######  IPD-MA may be conducted in either one or two stages. In one-stage IPD-MA, all IPD from every trial are analysed simultaneously, whilst accounting for the clustering of participants within studies. Hereby, researchers may model interactions between treatment and patient-level co-variables. Recent guidance suggests centring per trial the potential effect modifier [@Hua_2016], in order to separate within and across trial information and therefore avoid potential ecological bias. In two-stage IPD-MA on the other hand each trial is first analysed separately using an appropriate statistical model. For instance, the first stage may estimate different effects observed per subgroup, or the treatment-covariate interaction effect. Subsequently these effects are pooled using typical meta-analytical methods. 

#######  Nevertheless, inferences driven from a single interaction term or from treatment effect differences between subgroups are unbiased when the co-variable domain is similar across studies and/or the effects are linear [@Simmonds_2007]. This assumption may not true and effect modification may have to be modelled using a non-linear function. Royston and Sauerbrei [@Royston_2004] proposed a strategy to model treatment effects over a continuous co-variable by fitting fractional polynomials (FPs) in single studies. In a subsequent article they extended their approach to IPD-MA using a two-stage approach. In the fist stage, a fractional polynomial is selected using one of the following three methods : 1) the best fitting overall fractional polynomial, 2) the best fitting -per trial- second degree FPs 3) the best fitting -per trial- FPs (any combination of linear, FP1 or FP2). Then treatment effect function per trial is estimated. As a second step the per trial treatment effect functions are pooled using a pointwise meta-analysis. Nevertheless, the assumption that the outcome-effect modifier association has the same shape in both treatment arms may not be true. Furthermore, fractional polynomial rely on tests with arbitrary $\alpha$ significance level. Finally, FPs are global polynomial functions and may not fit well on the boundaries of the continuous effect modifier. 

####### We propose the use of generalised additive mixed effect models with smoothing splines to model the outcome-effect modifier. Since effect modification may not be constant and therefore detected by a single term, we propose the use of treatment effect function and the corresponding treatment effect plot. We present two extreme cases applied in simulated data and 2 empirical examples   


# 2. Example data-sets
## 2.1 Empirical data-sets

\par        We use 2 IPD-sets to illustrate aforementioned methods. The first IPD-MA investigates the effect of antibiotics in children with acute otitis media [@Rovers_2006]. Rovers et al. collected IPD from 6 randomised clinical trials with a total of 1643 children, aged from 0-12 years old. The primary outcome was fever and/or ear-pain after 3-7 days (yes/no). They concluded that antibiotics were more beneficial in younger children (less than 2 years old) with bilateral acute otitis media. Bilateral acute otitis media (yes/no), age, otorrhea were investigated also separately for potential effect modification and only bilateral acute otitis media showed a significant result. The second [@Gevers_2013] considers an IPD-MA to investigate the effect of Somatostatin on liver volume reduction. Gevers et al. collected IPD from 3 randomised placebo-controlled trials with a total of 107 participants. In this example, the outcome was continuous (liver volume reduction), and age, sex, baseline liver volume, and diagnosis of either autosomal dominant polycystic liver or kidney disease were investigated for effect modification . They concluded that use of Somatostatin was more beneficial for younger (<47) female patients. One of the 3 trials had a cross-over design, therefore participants were treated both with the active and the control treatment in different time periods. In order to use these data for our illustrative purposes, we removed the cross-over design and used all patients only once, by selecting half of the patients from the active period and the other half (sex and age-matched) from the control period. Therefore, differences between our results and those reported in the original article may occur.

## 2.2 Simulated data-sets

We simulated 2 data-sets which we consider extreme cases. The first data-set has 


# 3. Methods

In our study we a the use of generalised mixed effects models with smoothing splines to investigate the effect modification of a treatment across a continuous variable. We will also fit the equivalent generalised linear mixed effects model and compare their results. 

 
## 2.1 Statistical approaches

## Generalised additive mixed models

In generalised additive mixed models we 



# Results



```{r One-Stage smoothing splines in Somatostatin }

# Note: this is really not the best fitting model for the data:
m1 <- bam(dif_liver_perc ~ Drug*Gender*Age + 
            s(Study,Age,bs = "re") + 
            s(Study,Gender,bs = "re") + 
            s(Study,Drug,bs="re") , data = somatostatin,method="REML" ,  discrete=TRUE)


par(mfrow=c(2,1), cex=0.75)
plot_diff(m1, view='Age',cond = list(Gender="Male") , comp=list(Drug=c("placebo", "somatostatin")), 
    rm.ranef=TRUE, col = "darkblue",print.summary = F, main = "Men", 
    xlab = "Age (in years)",
    ylab = "Estimated treatment difference")

plot_diff(m1, view='Age',cond = list(Gender="Female") , comp=list(Drug=c("placebo", "somatostatin")), 
    rm.ranef=TRUE, col = "darkgreen",print.summary = F, main = "Women",
    xlab = "Age (in years)",
    ylab = "Estimated treatment difference ")

```



```{r}
par(mfrow=c(1,2), cex=1.1)
# version 1:
plot_smooth(m1, view="Age", plot_all="Drug", rm.ranef=TRUE, se = 2.56)

```

```{r One-Stage smoothing splines in AOM study }

# Note: this is really not the best fitting model for the data:
m1 <- bam(poutcome ~bilat_0*treat*age + s(age) + 
            s(study,age,bs = "re") + 
            s(study,bilat_0,bs = "re") + 
            s(study,treat,bs="re") , family = binomial("identity"), data = IPDMA, method="REML" ,  discrete=TRUE)

par(mfrow=c(2,1), cex=0.75)
plot_smooth(m1, view="age", plot_all="treat", cond = list(bilat_0="No") ,  rm.ranef=TRUE, se = 1.96)
plot_diff(m1, view='age',cond = list(bilat_0="No") , 
          comp=list(treat=c("Placebo", "Antibiotics")), 
          rm.ranef=TRUE, col = "darkblue",print.summary = F, main = "Children with unilateral otitis media", 
          xlab = "Age (in years)", ylab = "Estimated difference (log-scale)")



```



```{r}
par(mfrow=c(2,1), cex=0.75)
plot_smooth(m1, view="age", plot_all="treat", cond = list(bilat_0="Yes") ,  
            rm.ranef=TRUE, sim.ci=TRUE, se = 0.8, transform = "exp")
plot_diff(m1, view='age',cond = list(bilat_0="Yes") , comp=list(treat=c("Placebo", "Antibiotics")), 
    rm.ranef=TRUE, col = "darkgreen",print.summary = F, main = "Children with bilateral otitis media",
    xlab = "Age (in years)", mark.diff = T,col.diff =  "purple",sim.ci=TRUE, 
    ylab = "Estimated difference (log-scale)")
```