---
title: "Overview and illustration of methods to investigate effect modification across
  a continuous covariate"
author: "Michail Belias"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{bbm}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{dsfont}
  - \usepackage{multirow}
  - \usepackage[table]{xcolor}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
output:
 pdf_document:
  fig_caption: yes 
  fig_height: 8
  fig_width: 8
 indent: true  
 word_document:
  reference_docx: Style and bibliography/templatePaper.docx
 html_document:
  df_print: paged
csl: Style and bibliography/journal-of-clinical-epidemiology.csl
fontsize: 14pt 
sansfont : GFS Neohellenic
bibliography: Style and bibliography/bibliography2.bib
---


```{r global_options , echo=FALSE, message=FALSE, warning= FALSE}
rm(list=ls()) ### To clear namespace
## Fractional Polynomials
## Load data-set
if(!require("readr")) install.packages("readr")
## Load ggplot2 for plotting
if(!require("ggplot2")) install.packages("ggplot2")
## Load gridExtra for fine tuning
if(!require("gridExtra")) install.packages("gridExtra")
## Load knitr for fine tuning
if(!require("knitr")) install.packages("knitr")
## Load haven for fine tuning
if(!require("haven")) install.packages("haven")
## Load dplyr
if(!require("dplyr")) install.packages("dplyr")
## Load lme4 for lme4
if(!require("lme4")) install.packages("lme4")
## Load lme4 for lme4
if(!require("pander")) install.packages("pander")
## Load lme4 for lme4
if(!require("kableExtra")) install.packages("kableExtra")
## Load lme4 for lme4
if(!require("magick")) install.packages("magick")
## Load glmertree for glmm trees modelling
if(!require("glmertree")) install.packages("glmertree")
## Load GGally for better ggplot2 manipulation
if(!require("GGally")) install.packages("GGally")
## Load GGally for better ggplot2 manipulation
if(!require("readxl")) install.packages("readxl")
## Load GGally for better ggplot2 manipulation
if(!require("kableExtra")) install.packages("kableExtra")
## Load GGally for better ggplot2 manipulation
if(!require("ggsci")) install.packages("ggsci")
## Load broom for ggplot2  manipulation
if(!require("broom")) install.packages("broom")
## Load broom for ggplot2  manipulation
if(!require("metafor")) install.packages("metafor")
if(!require(effects)) install.packages("effects")


opts_chunk$set(fig.width=9, fig.height=6, fig.path='Figs/',
        echo=F, warning=FALSE, message=FALSE, fig.pos = "H", comment = "")
options(knitr.table.format = "html")


Sys.setenv(PATH=paste(Sys.getenv("PATH"),"C:/Program Files/MiKTeX 2.9/miktex/bin/x64/",sep=";"))

```

```{r loading the datasets}

IPDMA <- read_sas("Data/IPDMA.sas7bdat")
names(IPDMA) <- tolower(names(IPDMA))
IPDMA$treat =  factor(IPDMA$treat  , labels = c("Placebo","Antibiotics") )
IPDMA$study = factor(IPDMA$study, labels = c("Damoiseaux","Burke","Appelman","Little","Saux","McCormick"))
IPDMA$bilat_0 =  factor(IPDMA$bilat_0  , labels = c("No","Yes") )




somatostatin <- read_sav("Data/somatostatin.sav")
source("Data/somatostatin_descriptives.R")
```
# Abstract (116 out of 200 words)

## Objective 

To overview and illustrate a variety of tree-based and regression-based approaches to detect and model effect-modification in meta-analysis(MA) of individual participant data(IPD), such as: covariate-centred IPD-MA, mixed effects fractional polynomials, splines, meta-stepp and glmm-trees.

##  Study Design and Setting

We applied the aforementioned approaches into two empirical data-sets. The first is investigating the effect of somatostatin treatment versus placebo in liver reduction percentage, on participants with polycystic liver disease. The second investigates the effect of antibiotics in fever/ear-pain reduction, on children with acute otitis media(AOM).

## Results
Non-linear association was detected in AOM IPD-MA. 


## Conclusion

We conclude that subgroup detection in IPD-MA requires knowing the underlying assumptions and careful modelling. Effect modification may be distorted by a non-linear association if left unadjusted. 



\newpage

##### 

# 1. Introduction


\par      Individual participant data meta-analysis (IPD-MA) is a type of systematic review, where data gathered from multiple studies are combined and analysed centrally. The capability to standardise subgroup definitions and outcomes across studies, the increased power to investigate other than linear associations, the increased validity and reliability of the subgroups and the flexibility to search for subgroups based on combinations of patient and/or disease characteristics are some of the benefits of using IPD of multiple trials rather than traditional (aggregate) meta-analysis. A vivid field of research towards personalised healthcare is the investigation of effect modification. For this task, IPD-MA is considered a gold standard as single trials rarely have sufficient power to identify relevant effect modification. 
\par      Effect modification may be present in both categorical and/or continuous covariates. For example, differences in the treatment effect may be present between smokers and non-smokers. In this case, subgroups are already defined and therefore, only hypothesis testing may be conducted. Then the investigation of subgroup effects is performed using statistical tools, such as generalised linear models combined with meta-analytical tools, or generalised linear mixed-effects models with interaction terms included. Subsequently, the estimated coefficients are checked for statistical significance. On the other hand, effect modification across a continuous covariate is more challenging, as the subgroups are non-existent or not be a-priori known. Besides confirming an effect modification, we may be compelled to further explore also the association of the variable with the outcome.

A common technique is to categorise the continuous covariate, using some prior knowledge. Thereto, subgroups are generated using prior knowledge driven from literature. Nevertheless, this technique is only reasonable when we wish to confirm a treatment effect difference across the levels of the dichotomous variable. Furthermore, categorisation has been criticised for misspecification, loss of information and power, inflation of the type I error rate when adjusting for confounding and biased results [@Royston_2005 ; @Altman_2006 ; @Austin_2004 ; @Maxwell_1993 ; @Weinberg_1995]. Another common practice is to assume linearity over the link function, a method that may also lead to deterioration of power, misspecification and even spurious results [@J_rgensen_2016]. Therefore, besides confirming a variable if is an effect modifier, we may have to the explore the functional form of the outcome-effect modifier association. Various approaches to account for non-linear associations have been developed, such as: fractional polynomials (FPs) [@Sauerbrei_2011, @royston_interaction_2013] and splines. 
\par      Regression based approaches such as: linear models, piecewise polynomials, fractional polynomials and smoothing splines may be performed either in one or two stages. In two-stage approach, each trial is first modelled separately, using an appropriate statistical model of choice. Subsequently, we pool either the extracted estimates or the fitted functions across trials using standard meta-analytical tools. In contrast, in one-stage IPD-MA all IPD from every trial are analysed simultaneously whilst accounting for the clustering of participants within studies. Hereto, researchers may model interactions between treatment and patient-level covariate while accounting also for the shape of the association. Recent recommendations, suggest mean-centring the potential effect modifiers per trial in order to account for potential ecological bias due to unadjusted confounding. Within trials clustering can be accounted using either fixed effect**s** (stratified intercept/slope), fixed effect (common intercept/slope) or random effects (intercept and/slopes driven from a common Normal distribution) [@Legha_2018]. Finally, state-of-the-art plot and tree-based methods have been developed for exploring effect modification. Generalised linear mixed-effects model trees (glmertree) introduced by Fokkema et al. [@Fokkema_2017] can handle non-linear associations, whilst accounting for within studies clustering of the participants. Meta-stepp is a plot based moving average (sliding window) method that approximates non-linear effects from clustered data [@Wang_2016]. Finally, although, providing the whole information of the outcome-continuous effect modifier association is more informative clinical decisions are based in knots in which the treatment effect is altered. These knots may be altered if the assumptions are altered or if the outcome-effect modifier functional form is mis-specified.
\par
  It is often unclear when each method should be preferred. It is also unclear if the treatment effect function [@Royston_2008] or interaction term analysis [@Sun_2010] is most appropriate in randomised clinical trials (RCT) meta-analysis framework. We aim to describe and illustrate the aforementioned methods. For that task, we will use both regression-based approaches such as meta-stepp, centred one-stage IPD-MA, mixed effects fractional polynomials and splines, and tree-based approaches such as generalised linear mixed-effects model trees. Although confirmatory and exploratory data analyses are almost never conducted one without the other we wish to point out that we will focus on the exploratory part. For instance, we may explore for potential effect modification and/or functional form of outcome-effect modifier association, or for effect modification on a subgroup, or how many times does the effect change over a continuous variable, and at which cut-points. We will introduce the data and the methods we used in chapter 2 and apply them on real empirical data to illustrated their performance. 

# 2. Data
We use 2 empirical IPD-sets. The first data-set [@Rovers_2006] was investigating the effect of antibiotics in acute otitis media on children aged from 0 to 12 years old. Rovers et al. collected IPD from 6 randomised clinical trials with a total of 1643 children, aged from 0-12 years old. The primary outcome was fever and/or ear-pain after 3-7 days (yes/no). Rovers et al. concluded that antibiotics were more beneficial in younger children (less than 2 years old) with bilateral acute otitis media. Bilateral acute otitis media (yes/no), age, otorrhea were also investigated separately for potential effect modification and only bilateral acute otitis media showed a significant result.

The second data-set [@Gevers_2013] was investigating the effect of somatostatin in the liver volume reduction. Gevers et al. collected IPD from 3 randomised placebo-controlled trials with a total of 107 participants. The outcome was continuous (liver volume reduction) and age, sex, baseline liver volume, and diagnosis of autosomal dominant polycystic liver or kidney disease has been investigated for effect modification. Gevers et al. concluded that therapy using somatostatin was more beneficial for young female patients. One of the included trials [Caroli et al.] had a cross-over design, therefore participants were in both treatment groups (control and treated) in different time periods. We matched the participants per age and gender and picked half on the treated and half on the control group. Therefore, some differences between our results and those reported in the original article may occur.

```{r}
library(dplyr)
a = IPDMA %>%
    group_by(study, treat)%>%
  summarise(`Number of participants` = n(), 
            `Age, median [range]` =  paste(round(median(age),2)  , " [" , round(min(age),2), ",",round(max(age),2) ,"]", sep = "" ) ,
            `Males (%)` = paste(sum(gender) , " (" , paste(round(100*mean(as.numeric(gender))),"%",sep = "") , ")", sep = "" ),
            `RAOM (%)`= paste(sum(raom) , " (" , paste(round(100*mean(as.numeric(raom))),"%",sep = "") , ")", sep = "" ), 
            `Sibling (%)`= paste(sum(sibling) , " (" , paste(round(100*mean(as.numeric(sibling))),"%",sep = "") , ")", sep = "" ),
            `Winter season (%)` =  paste(sum(season) , " (" , paste(round(100*mean(as.numeric(season))),"%",sep = "") , ")", sep = "" ),
            `Being breastfed (%)`=  paste(sum(breast) , " (" , paste(round(100*mean(as.numeric(breast))),"%",sep = "") , ")", sep = "" ),
            `Passive smoking (%)` = paste(sum(smoke) , " (" , paste(round(100*mean(as.numeric(smoke))),"%",sep = "") , ")", sep = "" ),
            `Crying (%)` =paste(sum(cry_0) , " (" , paste(round(100*mean(as.numeric(cry_0))),"%",sep = "") , ")", sep = "" ),
            `Runny nose (%)`=paste(sum(rnose_0) , " (" , paste(round(100*mean(as.numeric(rnose_0))),"%",sep = "") , ")", sep = "" ),
            `Ear pain (%)` = paste(sum(pain_0) , " (" , paste(round(100*mean(as.numeric(pain_0))),"%",sep = "") , ")", sep = "" ),
             `Fever (%)` = paste(sum(fever_0) , " (" , paste(round(100*mean(as.numeric(fever_0))),"%",sep = "") , ")", sep = "" ),
            `Otorrhoea (%)` = paste(sum(oto_0) , " (" , paste(round(100*mean(as.numeric(oto_0))),"%",sep = "") , ")", sep = "" ),
            `Red tympanic membrane (%)` = paste(sum(tmcol_0) , " (" , paste(round(100*mean(as.numeric(tmcol_0))),"%",sep = "") , ")", sep = "" ),
            `Bulging tympanic membrane (%)` = paste(sum(tmbul_0) , " (" , paste(round(100*mean(as.numeric(tmbul_0))),"%",sep = "") , ")", sep = "" ))


final=t(a[,3:17])
colnames(final) = rep(c("Placebo","Antibiotics"),6)
#%>%
  #kable_as_image()
if(isTRUE(is_latex_output() || is_html_output() )){
kable(final, format = "latex",
      longtable = T, 
      booktabs = T, caption = "Baseline Characteristics (Rovers et al.)" ) %>%
  kable_styling(latex_options = c("striped"),font_size =8, full_width = T, position = "center") %>%
  row_spec(row = 0,  bold = T) %>%
    row_spec(2, bold = T, color = "white", background = "#FF6348FF")%>%
    column_spec(column =  0,  bold = T) %>%
  add_header_above(c(" " = 1, "Damoiseaux" = 2, "Burke" = 2, "Appelman" = 2, "Little" = 2, "Saux" = 2, "McCormick" = 2) )%>%
  landscape()
}else{
  kable(final, format = "latex",
      longtable = T, 
      booktabs = T, caption = "Baseline Characteristics (Rovers et al.)" ) %>%
  kable_styling(latex_options = c("striped"),font_size =8, full_width = T, position = "center") %>%
  row_spec(row = 0,  bold = T) %>%
    row_spec(2, bold = T, color = "white", background = "#FF6348FF")%>%
    column_spec(column =  0,  bold = T) %>%
  add_header_above(c(" " = 1, "Damoiseaux" = 2, "Burke" = 2, "Appelman" = 2, "Little" = 2, "Saux" = 2, "McCormick" = 2) )%>%
  landscape()%>%
  kable_as_image()
  }

```


```{r}

b = somatostatin %>%
    group_by(Study, Drug)%>% 
    summarise(`Number of participants` = n(), 
              `Age, median [range]` =  paste(median(Age)  , " [" , min(Age) , ",",max(Age) ,"]", sep = "" ) ,
              Female = paste(sum(Gender == "Female") , " (" , paste(round(100*mean(as.numeric(Gender == "Female"))),"%",sep = "") , ")", sep = "" ),
              Male = paste(sum(Gender == "Male") , " (" , paste(round(100*mean(as.numeric(Gender == "Male"))),"%",sep = "") , ")", sep = "" ),
              ADPKD= paste(sum(Diagnosis == "0") , " (" , paste(round(100*mean(as.numeric(Diagnosis == "0"))),"%",sep = "") , ")", sep = "" ), 
              PCLD= paste(sum(Diagnosis == "1") , " (" , paste(round(100*mean(as.numeric(Diagnosis == "1"))),"%",sep = "") , ")", sep = "" ),
              `Liver volume, mL , median [range]` =  paste(median(Base_Liver)  , " [" , min(Base_Liver) , ",",max(Base_Liver) ,"]", sep = "" ))


final=t(b[,3:9])
colnames(final) = rep(c("Placebo","Somatostatin"),3)

if(isTRUE(is_latex_output() || is_html_output() )){
  kable(final, format = "latex",
      longtable = T, 
      booktabs = T, caption = "Baseline Characteristics (Gevers et al.)" ) %>%
  kable_styling(latex_options = c("striped"),font_size =8, full_width = T, position = "center") %>%
  row_spec(row = 0,  bold = T) %>%
    column_spec(column =  0,  bold = T) %>%
  add_header_above(c(" " = 1, "van Keimpema et al" = 2, "Hogan et al" = 2, "Caroli et al" = 2) )%>%
  landscape()
}else{
      kable(final, format = "latex",
      longtable = T, 
      booktabs = T, caption = "Baseline Characteristics (Gevers et al.)" ) %>%
  kable_styling(latex_options = c("striped"),font_size =8, full_width = T, position = "center") %>%
  row_spec(row = 0,  bold = T) %>%
    column_spec(column =  0,  bold = T) %>%
  add_header_above(c(" " = 1, "van Keimpema et al" = 2, "Hogan et al" = 2, "Caroli et al" = 2) )%>%
  landscape()%>%
  kable_as_image()
  }
```


# 3. Methods
## 3.1 Notation

We are denoting the studies as j = 1,2 ,...,J, individuals as i= 1, 2...,I, the  per trial mean of age as $\bar{Age_j}$, cut-point as $\kappa$


## 3.2. Recursive-partitioning (tree-based) methods 
### 3.2.1 Generalised Linear Mixed Model Trees (glmm or glmer trees)

Generalised linear mixed model trees approach is a state-of-the-art technique, proposed by Fokkema et al [@Fokkema_2017] for the detection of treatment-effect modifier interaction. A model-based recursive partitioning [@Zeileis_2008;  @Su_2009] algorithm is applied, while also considering the clustered structure of datasets.

The GLMM tree algorithm:

(1) fit the parametric model to the dataset, 
(2) statistically test for parameter instability with respect to each of a set of partitioning variables, 
(3) if there is some overall parameter instability, split the dataset with respect to the variable associated with the highest instability,
(4) repeat the procedure in each of the resulting subgroups.



## 3.3 Regression based approaches

We identify 2 assumptions that a researcher may a-priori have. The first is over the functional form the association of the outcome with the continuous covariate have and the second one over the knots known also as cut-offs or knots, where the effect is modified. In this framework, we consider that given the assumptions made we may choose the appropriate analysis to perform. 


```{r, out.height="80%", out.width="80%"}
library(knitr)  

include_graphics("Figs/Assumption.png")
```

```{r, out.height="80%", out.width="80%"}
include_graphics("Figs/TypesOfMethods.png")
```

```{r }

MethodsComparison <- read_excel("Figs/MethodsComparison.xlsx")
MethodsComparison <- as.data.frame(MethodsComparison)

MethodsComparison[is.na(MethodsComparison)] <-  ""



kable(MethodsComparison, caption = "Characteristics of the methods",  format = "latex", booktabs = T )%>%
kable_styling(latex_options = c("striped", "scale_down"))%>%
kable_styling(full_width = F) %>%
column_spec(1, bold = T, width = "10em") %>%
column_spec(2, width = "10em")%>%
column_spec(3, width = "6em")%>%
column_spec(4, width = "10em")

```

### 3.3.1. Two-stage approaches

In two-stage approaches a statistical model of choice is directly fitted per trial.
The statistical model per trial j is as follows:

$$g(Y_{ij}) = f_{1j}(X)  + f_{2j}(X) \times Treatment$$ \begin{flushright} [1] \end{flushright}

Subsequently, we can either pool the coefficients or the fitted functions using typical meta-analytical tools. 

#### 3.3.1.1 First stage: Per-trial modelling

The functions $f_{1j}, f_{2j}$ are providing the functional shape of the outcome-effect modifier association per trial j for the treated and the control respectively. Depending on the a-priori knowledge of the association's functional form and the knots where the effect is altered we may fit: 

*For known functional form and known knots*

  * Piecewise-polynomials with m knots (knots)
  $$f_1 = \sum_{\kappa =1}^{\kappa= m}f_{1\kappa}(X_{x_{k-1} \leq X < x_{k-1}} ) f_2 =  \sum_{\kappa =1}^{\kappa= m}f_{2\kappa}(X_{x_{k-1} \leq X < x_{k-1}} )$$
Piecewise-polynomials mostly used are piecewise intercepts, linear, quadratic and cubic, where:
    - Piecewise-intercept: within each interval [a ,b] both f1, f2 have the form of $\beta_{[a ,b]}$ 
    - Piecewise-linear:  within each interval [a ,b] both f1, f2 have the form of $\beta_{0[a ,b]} + \beta_{1[a ,b]} \times X$
    - Piecewise-quadratic:  within each interval [a ,b] both f1, f2 have the form of $\beta_{0[a ,b]} + \beta_{1[a ,b]} \times X + \beta_{2[a ,b]} \times X^2$

*Known functional form and no knots*

  * Global-polynomials: $$f_1 =  \sum_{p=1}^{p=m} \beta_{1p} \times X^p$$ $$ f_2 = \sum_{p=1}^{p=m} \beta_{2p} \times X^p$$
    - linear: $f_1 =  \beta_{10} +  \beta_{11} \times X , f_2 = \beta_{20} +  \beta_{21} \times X$
    - Quadratic: $f_1 =  \beta_{10} +  \beta_{11} \times X +  \beta_{12} \times X^2 , f_2 = \beta_{20} +  \beta_{21} \times X +   \beta_{22} \times X^2$
    - Cubic: $f_1 =  \beta_{10} +  \beta_{11} \times X +  \beta_{12} \times X^2 +  \beta_{13} \times X^3 , f_2 = \beta_{20} +  \beta_{21} \times X +   \beta_{22} \times X^2 +   \beta_{23} \times X^3$

#### Smoothing splines

Splines are a generalisation of piecewise polynomials and can offer great flexibility in the shape of the outcome-effect modifier association. Regression splines of an **m** degree, should be continuous, have **m-1** continuous derivatives and the $m^{th}$ derivative should constant with the knots. They are quite similar to piecewise polynomials, with the difference that they are continuous across the knots.
A natural spline has an extra assumption that the second derivative of the function in the edges $\kappa_0, \kappa_m$ of the association is 0. This is a something that should be considered when the goal of our research is to forecast future outcomes such as in some longitudinal or time series studies.  
Typically, when using splines the real underlying shape is not known. Furthermore, the knots may not be known already, and may be part of the exploratory analysis we are performing. We can introduce even more flexibility into our model a perform smoothing splines. Smoothing splines are by-pass the problem of knot selection by shrinking the coefficients to their basis expansion. In order to do so, they minimise a penalised least squares criterion or equivalently the maximum likelihood with an extra parameter to penalise the wingliness of the line, 
$MLE + \lambda\int_0^1[f^{''}(x)]^2 dx$ equivalently $|| y - X\beta ||^2 + \lambda\int_0^1[f^{''}(x)]^2 dx$ or in algebraic form $|| y - X\beta ||^2 + \lambda\beta^TS\beta$.


#### Fractional polynomials

*Unknown functional form and unknown knots*

Fractional polynomials [@Royston_1994] are an extension of polynomials, that also include negative powers. FPs provide a global functional form. FPs model the effect of a covariate X as $f(x;\beta) =  \sum_{k=1}^{k=m} \beta_{k} \times X^{p_{k}}$, where m is the degree of the fractional polynomial and the power is derived from a fixed set of powers $p_k \in S :$ {-2,-1,-0.5, 0=(log),0.5,1,2}. The Fractional selection procedure FSP algorithm (FSP) has been proposed [@Ambler_2001,@Sauerbrei_1999] to explore the best fitting fractional polynomial. The fractional polynomials of a common degree **m** are tested using the deviance difference criterion, whilst fractional polynomials of different degree are compared using a $\chi^2$ test. When multiple data-sets are present Sauerbrei and Royston [@Sauerbrei_2011], have proposed 3 methods to evaluate the general functional form. 

  * Overall FP, where the FSP is applied in the pooled data, in order to find the best FP (stratified by data-set).
  * Study-wise FP2, the best FP2 is selected for each study
  * Study wise selected FP, where the best fitting FP is extracted per study


#### 3.3.1.2 Second-stage combination of the first stage elicitations

As a second-stage in the two-stage IPD-MA, we may either pool the estimates or the fitted functions extracted from the first stage. The coefficients $\beta_i$ and $SE_i$, extracted in the first stage can be used in a multi-variate meta-analysis (CE or RE) to give an overall mean to extract the pooled $b_0$ and its SE. This approach only works when common powers have been used across studies. Therefore, it is applicable in piecewise and global polynomials, and fractional polynomials fitted using the overall FP procedure. we applied a random-effects meta-analysis, using the EB method for the $\tau^2$ estimation [@Stijnen_2007] and the HKSJ adjustment [@Hartung_2001,@IntHout_2014].  

The fitted function g can be calculated per study $\hat{g_i}(x; \beta_i)$ and derive its standard error from $S_i$. Then we perform a meta-analysis, to get a pooled estimate $\hat{g_i}(x; \beta_i)$ and its variance.

### 3.3.2. One-stage approaches
#### 3.3.2.1 Centred One-stage IPD-MA

We follow recent recommendations [@Hua_2016, @Legha_2018 ] and centre per trial the effect modifier. This way we can separate the within and across trial information of the effect modification. As in the two stage methods we can fit piecewise and global polynomials, but using a mixed-effect model to account for within trials clustering.
Therefore, assuming that $X_{ij} = Age_{ij} - \bar Age_j$ the statistical model will be: 

$g(Y_{ij}) = f_{1j}(X)  + f_{2j}(X) \times Treatment$          

The $f_{1j}$ and $f_{2j}$ can be either piecewise polynomials, global polynomials or splines as described in section *3.3.1.1*. This 


For the $\beta_{1kpj}$ and $\beta_{2kpj}$ we can assume, either fixed (common) effect, fixed effect*s* (stratified betas), or random effects. If we choose the fixed effect approach a common beta is assumed, in the stratified approach j betas will be generated which correspond to the per trial beta, while in the random effects we assume that the per trial coefficients are driven from a common Normal distribution N($b, \sigma^2$). 

#### 3.3.2.2 Multilevel Fractional polynomials

Fractional polynomials may be used using one stage approach [@Long_2010,  @Johnson_2012]. In this case, we use the same set of powers as in the FSP method. Furthermore, we fit a mixed effect model of our choice, with either stratified, fixed or random effects. For model selection we can use the lowest deviance or the Akaike Information Criterion (AIC) [@Akaike_1974], or Bayesian Information Criterion (BIC) [@Schwarz_1978]. 

Therefore, the statistical model applied is:

$g(Y_{ij}) = FP_{1j}(X)  + FP_{2j}(X) \times Treatment$


\newpage

##### 

# Results

We illustrate the results of the aforementioned approaches by ascending order of assumptions made. Therefore, we will start with the tree-based approach and smoothing spline, as we believe that these should be the first "exploratory" steps. We increased the level of significance, due to small sample size per trial. 


```{r lmer tree somatostatin }
tree  = lmertree(dif_liver_perc~Drug |(Drug| Study) | Age + Gender  , alpha=0.3,
               data = somatostatin, lmer.control = lmerControl(calc.derivs = F))
plot(tree, which = "tree",main = "Gevers et al")
``` 

We show that there is a difference between the average outcomes of male and females. This difference seems to emanate from young women ($\leq$ 46 years). 


```{r glmer tree AOM }
tree  = glmertree(poutcome ~treat |(1| study) | bilat_0 + age+  gender,
                  family = binomial("log"),
                  alpha=0.17, data = IPDMA)
plot(tree, which = "tree",main = "Rovers et al")

```

On the Gevers et al. dataset we show that age is a potential effect modifier and we may also have a tree-way interaction with bilateral otitis.


*Two-stage smoothing splines*

In contrast with linear regression models, in nonlinear models we cannot interpret the shape of the regression line from the summary. Therefore, visualization is an important tool for interpretating nonlinear regression models. Here a selection of visualization functions is summarized. Detailed information on the functions and examples are found in the help files of each function.



```{r message=FALSE}
library(mgcv)
library(itsadug)
# Note: this is really not the best fitting model for the data:
m1 <- bam(poutcome ~ bilat_0 * treat*age + s(age)  + s(age, study, bs='fs', m=2, k=5), data=IPDMA, discrete=TRUE, family = binomial("log"))

par(mfrow=c(2,1), cex=0.75)

# version 2:
plot_smooth(m1, view="age", cond=list(bilat_0="Yes",treat ="Antibiotics"), rm.ranef=TRUE, rug=FALSE, col="red")
plot_smooth(m1, view="age", cond=list(bilat_0="Yes",treat ="Placebo"), rm.ranef=TRUE, rug=FALSE, col="blue", add = T)
# version 2:
plot_smooth(m1, view="age", cond=list(bilat_0="No",treat ="Antibiotics"), rm.ranef=TRUE, rug=FALSE, col="red")
plot_smooth(m1, view="age", cond=list(bilat_0="No",treat ="Placebo"), rm.ranef=TRUE, rug=FALSE, col="blue", add = T)


```

*Two-stage GLMs*

In two-stage meta-analysis of interaction terms using linear assumptions, effect modification across age was not statistically significant. 

```{r drawing the continuous outcome plot}

df = somatostatin%>%
  group_by(Study)%>%
  do(fit = lm(dif_liver_perc~ Drug *Age, data = .))


# get the coefficients by group in a tidy data_frame
df_two_stage = tidy(df, fit)

###
Interactions =  df_two_stage[which(df_two_stage$term == "Drugsomatostatin:Age"),]
forest(rma(data = Interactions, yi = estimate, sei = std.error, slab = Study) )

```

*One-stage IPD-MA (linear assumption)*

```{r}

lmLinear <- lmer(dif_liver_perc ~ Drug * Age*Gender + (Drug|Study) + (1|Study) , data = somatostatin , control = lmerControl(calc.derivs = F))


IPDMA$bilateral = factor(IPDMA$bilat_0 , labels = c("Unilateral acute otitis","Bilateral acute otitis" ),  levels = c("No","Yes") )
glmLinear <- glmer(poutcome ~ treat * age*bilateral + (treat|study) + (1|study) , family = binomial("log"),data = IPDMA , control = glmerControl(calc.derivs = F))

summary(lmLinear)
summary(glmLinear)

effect.boundaries =  data.frame(effect(c("Age","Drug","Gender"),lmLinear, xlevels=70))
glm.effect.boundaries =  data.frame(effect(c("age","treat","bilateral"),glmLinear, xlevels=100))


ggplot() + 
  geom_point(somatostatin, mapping = aes(y= dif_liver_perc, x = Age, color =Drug)) + 
  scale_x_continuous(breaks = seq(from = 30, to = 70, by = 5))+ facet_grid(.~Gender)+
  theme_bw() +
  theme(legend.key = element_blank()) + ggtitle("Liver difference over age") +
  theme(plot.title = element_text(hjust = 0.5)) +   
  geom_line(effect.boundaries,mapping = aes(y= fit, x = Age,  color= Drug))+
  geom_ribbon(data = effect.boundaries,aes(ymin=lower, ymax=upper,y= fit, x = Age,  
                                           fill= Drug), alpha=0.2) +
  scale_color_lancet()+scale_fill_lancet()

ggplot() + 
  geom_point( subset(IPDMA, !is.na(bilateral)), mapping = aes(y= poutcome, x = age, color =treat, fill=treat)) + 
  scale_x_continuous(breaks = seq(from = 0, to = 13, by = 2))+ facet_grid(.~bilateral)+
  theme_bw() + xlab("Probability  of having fever after 3/7 days") +
  theme(legend.key = element_blank()) + ggtitle("Fever probability across age") +
  theme(plot.title = element_text(hjust = 0.5)) +   
  geom_line(glm.effect.boundaries,mapping = aes(y= fit, x = age,  color= treat))+
  geom_ribbon(data = glm.effect.boundaries,aes(ymin=lower, ymax=upper,y= fit, x = age,fill= treat), alpha=0.2) +
  scale_color_lancet()+scale_fill_lancet()

new.data =  somatostatin%>% 
  select(c("Study","Drug","Age","Gender"))


Female = cbind(effect.boundaries[effect.boundaries$Gender == "Female",])


Female.df =data.frame(predicted.difference  =  Female$fit [Female$Drug=="somatostatin"] - Female$fit [Female$Drug=="placebo"]) 

Female.df$se = sqrt(Female$se[Female$Drug=="somatostatin"] + Female$se[Female$Drug=="placebo"])
Female.df$Gender = rep("Female")


Male = cbind(effect.boundaries[effect.boundaries$Gender == "Male",])

Male.df =data.frame(predicted.difference  =  Male$fit [Male$Drug=="somatostatin"] - Male$fit [Male$Drug=="placebo"]) 

Male.df$se = sqrt(Male$se[Male$Drug=="somatostatin"] + Male$se[Male$Drug=="placebo"])
Male.df$Gender = rep("Male")
rm(Female,Male)


Full =  rbind(Female.df, Male.df)

rm(Female.df,Male.df)


new.data =  cbind(Age =effect.boundaries$Age[1:140], Full)
new.data$upper =  new.data$predicted.difference + 1.96*new.data$se
new.data$lower =  new.data$predicted.difference - 1.96*new.data$se


ggplot(new.data, mapping = aes(y= predicted.difference, x = Age)) + 
  geom_line() + facet_grid(Gender~.)+
  scale_x_continuous(breaks = seq(from = 30, to = 70, by = 5))+ 
  theme_bw() + 
  theme(legend.key = element_blank()) + ggtitle("Treatment effect (linear)") +
  theme(plot.title = element_text(hjust = 0.5))+
  geom_ribbon(data = new.data,aes(ymin=lower, ymax=upper,y= predicted.difference, x = Age), alpha=0.2) +
  scale_color_lancet() + geom_hline(yintercept = 0, linetype =3, colour= "purple", size = 1)

rm(lmLinear,effect.boundaries,effect.data.frame, new.data)


### For the AOM NOW
new.data =  IPDMA%>% 
  select(c("study","treat","age","bilateral"))


bilateral = glm.effect.boundaries[glm.effect.boundaries$bilateral == "Bilateral acute otitis",]


bilateral.df =data.frame(predicted.difference  =  bilateral$fit [bilateral$treat=="Antibiotics"] - bilateral$fit [bilateral$treat=="Placebo"]) 

bilateral.df$se = sqrt(bilateral$se[bilateral$treat=="Antibiotics"] + bilateral$se[bilateral$treat=="Placebo"])
bilateral.df$bilat = rep("bilateral")


unilateral = glm.effect.boundaries[glm.effect.boundaries$bilateral == "Unilateral acute otitis",]

unilateral.df =data.frame(predicted.difference  =  unilateral$fit [unilateral$treat=="Antibiotics"] - unilateral$fit [unilateral$treat=="Placebo"]) 

unilateral.df$se = sqrt(unilateral$se[unilateral$treat=="Antibiotics"] + unilateral$se[unilateral$treat=="Placebo"])
unilateral.df$bilat = rep("unilateral")
rm(bilateral,unilateral)


Full =  rbind(bilateral.df,unilateral.df)

rm(bilateral.df,unilateral.df)


new.data =  cbind(Age =glm.effect.boundaries$age[1:200], Full)
new.data$upper =  new.data$predicted.difference + 1.96*new.data$se
new.data$lower =  new.data$predicted.difference - 1.96*new.data$se


ggplot(new.data, mapping = aes(y= predicted.difference, x = Age)) + 
  geom_line() + facet_grid(bilat~.)+
  scale_x_continuous(breaks = seq(from = 30, to = 70, by = 5))+ 
  theme_bw() + 
  theme(legend.key = element_blank()) + ggtitle("Treatment effect (linear)") +
  theme(plot.title = element_text(hjust = 0.5))+
  geom_ribbon(data = new.data,aes(ymin=lower, ymax=upper,y= predicted.difference, x = Age), alpha=0.2) +
  scale_color_lancet() + geom_hline(yintercept = 0, linetype =3, colour= "purple", size = 1)

rm(glmLinear,glm.effect.boundaries, new.data,Full)

```




```{r table acute otitis media}


ggplot(IPDMA, aes(x=age, y=poutcome, color= treat)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family="binomial"), se=FALSE) + xlim(c(-1,15))+ scale_color_lancet() + 
  labs(title = "Scatterplot of AOM data-set",y = "Fever/Pain after 3/7 days probability ",x = "Age")

```






\newpage

#####

# Discussion


\newpage

##### 

# References



